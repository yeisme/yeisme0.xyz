+++
title = "æ·±å…¥ç†è§£ FUSEï¼šä» Hello World åˆ°æ–‡ä»¶ç³»ç»Ÿå®ç°åŸç†-01"
date = "2025-04-17T20:21:02+08:00"
description = ""
tags = []
categories = ["fuse","c"]
series = []
aliases = []
image = ""
draft = false
+++

# æ·±å…¥ç†è§£ FUSEï¼šä» Hello World åˆ°æ–‡ä»¶ç³»ç»Ÿå®ç°åŸç†-01

> [FUSE archlinuxcn wiki](https://wiki.archlinuxcn.org/zh-cn/FUSE)
> ç”¨æˆ·ç©ºé—´ä¸­çš„æ–‡ä»¶ç³»ç»Ÿ (Filesystem in Userspace) (FUSE) æ˜¯ä¸€ç§ç”¨äºç±» Unix æ“ä½œç³»ç»Ÿçš„æœºåˆ¶ï¼Œå®ƒä½¿éç‰¹æƒç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿè€Œæ— éœ€ç¼–è¾‘å†…æ ¸ä»£ç ã€‚è¿™æ˜¯é€šè¿‡åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œæ–‡ä»¶ç³»ç»Ÿä»£ç æ¥å®ç°çš„ï¼Œè€Œ FUSE å†…æ ¸æ¨¡å—ä»…æä¾›äº†åˆ°å®é™…å†…æ ¸æ¥å£çš„â€œæ¡¥æ¢â€ã€‚

FUSE æ˜¯ä¸€ä¸ªå…è®¸åœ¨ç”¨æˆ·ç©ºé—´å®ç°æ–‡ä»¶ç³»ç»Ÿçš„æ¡†æ¶ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•ç¼–ç¨‹è¯­è¨€ï¼ˆè™½ç„¶ C/C++ æ˜¯æœ€å¸¸è§çš„é€‰æ‹©ï¼Œå› ä¸º FUSE åº“æ˜¯ç”¨ C ç¼–å†™çš„ï¼‰æ¥åˆ›å»ºè‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ— éœ€æ·±å…¥å†…æ ¸ç¼–ç¨‹çš„å¤æ‚æ€§ã€‚è¿™ä¸ºå„ç§æœ‰è¶£çš„åº”ç”¨åœºæ™¯æ‰“å¼€äº†å¤§é—¨ã€‚

- å°†ç½‘ç»œåè®®æŒ‚è½½ä¸ºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ SSHFS, NFSï¼‰ã€‚
- å°†æ•°æ®åº“æˆ–äº‘å­˜å‚¨æœåŠ¡æŒ‚è½½ä¸ºæ–‡ä»¶ç³»ç»Ÿã€‚(ä¸ºäº†å­¦ä¹  JuiceFS ğŸ˜¢)

æœ¬æ–‡å°†ä»ä¸€ä¸ªæœ€ç®€å•çš„ FUSE ç¤ºä¾‹å‡ºå‘ï¼Œæ·±å…¥å‰–æ FUSE çš„å·¥ä½œåŸç†ã€æ¶æ„è®¾è®¡åŠå…¶åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­çš„åº”ç”¨ï¼Œå¸®åŠ©è¯»è€…ä¸ä»…ç†è§£å¦‚ä½•ä½¿ç”¨ FUSEï¼Œæ›´èƒ½æ´æ‚‰æ–‡ä»¶ç³»ç»Ÿçš„æœ¬è´¨ã€‚(è¿™æ˜¯ç¬¬ä¸€ç¯‡ï¼Œå¦‚æœåå“å¥½å°±ç»§ç»­å‡º)

{{< figure src="image.png" alt="fuse" >}}

## ç»“æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶åˆ†æ

åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªåä¸º hello.txt çš„åªè¯»æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å›ºå®šä¸º"Hello World!\n"ã€‚è¿™æ˜¯ä¸€ä¸ªæ•™å­¦ç”¨çš„æœ€å° FUSE å®ç°ï¼Œå±•ç¤ºäº† FUSE çš„åŸºæœ¬å·¥ä½œåŸç†ã€‚

#### 1.Â  æ–‡ä»¶ç³»ç»Ÿç»“æ„

- æ ¹ç›®å½•`/`
- ä¸€ä¸ªæ–‡ä»¶`/hello.txt`ï¼Œå†…å®¹ä¸º"HelloÂ World!\n"

#### 2.Â  å®ç°çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

##### `hello_getattr`Â  å‡½æ•°

è·å–æ–‡ä»¶å±æ€§ï¼ˆç±»ä¼¼äº`stat`å‘½ä»¤çš„åŠŸèƒ½ï¼‰:

- å¯¹äºæ ¹ç›®å½•`/`ï¼šè®¾ç½®ä¸ºç›®å½•ç±»å‹ï¼Œæƒé™ 755
- å¯¹äº`/hello.txt`ï¼šè®¾ç½®ä¸ºæ™®é€šæ–‡ä»¶ï¼Œæƒé™ 444ï¼ˆåªè¯»ï¼‰ï¼Œå¤§å°ä¸ºå­—ç¬¦ä¸²é•¿åº¦
- å¯¹äºå…¶ä»–è·¯å¾„ï¼šè¿”å›"æ— æ­¤æ–‡ä»¶æˆ–ç›®å½•"é”™è¯¯

##### `hello_readdir`Â  å‡½æ•°

è¯»å–ç›®å½•å†…å®¹ï¼ˆå½“ç”¨æˆ·æ‰§è¡Œ`ls`å‘½ä»¤æ—¶è°ƒç”¨ï¼‰:

- åªå¤„ç†æ ¹ç›®å½•`/`
- åœ¨ç›®å½•ä¸­æ·»åŠ ä¸‰é¡¹ï¼š`.`ï¼ˆå½“å‰ç›®å½•ï¼‰ï¼Œ`..`ï¼ˆçˆ¶ç›®å½•ï¼‰å’Œ`hello.txt`æ–‡ä»¶
- ä½¿ç”¨`filler`å›è°ƒå‡½æ•°å°†ç›®å½•é¡¹å¡«å……åˆ° FUSE æä¾›çš„ç¼“å†²åŒºä¸­

##### `hello_open`Â  å‡½æ•°

æ‰“å¼€æ–‡ä»¶æ“ä½œ:

- åªå…è®¸æ‰“å¼€`/hello.txt`
- åªå…è®¸ä»¥åªè¯»æ¨¡å¼æ‰“å¼€ï¼ˆO_RDONLYï¼‰ï¼Œå…¶ä»–æ¨¡å¼è¿”å›è®¿é—®é”™è¯¯ï¼ˆEACCESï¼‰

##### `hello_read`Â  å‡½æ•°

è¯»å–æ–‡ä»¶å†…å®¹:

- æ ¹æ®æä¾›çš„åç§»é‡ï¼ˆoffsetï¼‰å’Œå¤§å°ï¼ˆsizeï¼‰è¯»å–`hello_str`å­—ç¬¦ä¸²
- å¤„ç†è¾¹ç•Œæƒ…å†µï¼Œç¡®ä¿ä¸ä¼šè¯»å–è¶…è¿‡å­—ç¬¦ä¸²é•¿åº¦çš„å†…å®¹
- è¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°

#### 3.Â  æ“ä½œå‡½æ•°è¡¨å’Œä¸»å‡½æ•°

`fuse_operations`ç»“æ„ä½“å®šä¹‰äº†æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„æ“ä½œé›†åˆï¼Œæœ¬ä¾‹ä¸­åªå®ç°äº†å››ä¸ªåŸºæœ¬æ“ä½œã€‚

`main`å‡½æ•°è°ƒç”¨`fuse_main`å¯åŠ¨ FUSE æ–‡ä»¶ç³»ç»Ÿï¼Œä¼ å…¥å‘½ä»¤è¡Œå‚æ•°å’Œæ“ä½œå‡½æ•°è¡¨ã€‚

## å®è·µ

- æ“ä½œç³»ç»Ÿ: Ubuntu 22.04
- CC: gcc version 11.4.0 (Ubuntu 11.4.0-1ubuntu1~22.04)
- CMAKE: cmake version 3.30.8

### æ–‡ä»¶ç»“æ„

```
CMakeLists.txt
hello
hello/main.c
```

```bash
sudo apt-get install libfuse-dev
```

```cmake
cmake_minimum_required(VERSION 3.10)

project(fuse_lib_dev VERSION 1.0.0)

# æŸ¥æ‰¾pkg-configå·¥å…·
find_package(PkgConfig REQUIRED)

# ä½¿ç”¨pkg-configæŸ¥æ‰¾FUSEåº“
pkg_check_modules(FUSE REQUIRED fuse)

# æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶
add_executable(fuse_lib_dev
    hello/main.c
)

# åŒ…å«FUSEå¤´æ–‡ä»¶ç›®å½•
target_include_directories(fuse_lib_dev PRIVATE ${FUSE_INCLUDE_DIRS})

# é“¾æ¥FUSEåº“
target_link_libraries(fuse_lib_dev ${FUSE_LIBRARIES})

# æ·»åŠ FUSEç›¸å…³ç¼–è¯‘é€‰é¡¹
target_compile_options(fuse_lib_dev PRIVATE ${FUSE_CFLAGS_OTHER})
```

```c
#define FUSE_USE_VERSION 26

#include <errno.h>
#include <fcntl.h>
#include <fuse.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// æ–‡ä»¶å†…å®¹
static const char* hello_str = "Hello World!\n";
static const char* hello_path = "/hello.txt";

/**
 *
 * @param path è¯†åˆ«ç”¨æˆ·å½“å‰è¯·æ±‚æ“ä½œçš„æ˜¯å“ªä¸ªæ–‡ä»¶æˆ–ç›®å½•
 * @param stbuf
 * @return
 */
static int hello_getattr(const char* path, struct stat* stbuf)
{
    int res = 0;


    memset(stbuf, 0, sizeof(struct stat));
    if (strcmp(path, "/") == 0)
    {
        stbuf->st_mode = S_IFDIR | 0755;
        stbuf->st_nlink = 2;
    }
    else if (strcmp(path, hello_path) == 0)
    {
        stbuf->st_mode = S_IFREG | 0444;
        stbuf->st_nlink = 1;
        stbuf->st_size = strlen(hello_str);
    }
    else
    {
        res = -ENOENT; // no such file or directory
    }

    return res;
}

/**
 * @brief
 * @param path è¯†åˆ«ç”¨æˆ·å½“å‰è¯·æ±‚æ“ä½œçš„æ˜¯å“ªä¸ªæ–‡ä»¶æˆ–ç›®å½•
 * @param buf FUSEå†…éƒ¨åˆ†é…çš„ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨ç›®å½•é¡¹ä¿¡æ¯
 * @param filler ç”¨äºå‘bufä¸­æ·»åŠ ç›®å½•é¡¹
 * @param offset ç›®å½•æµä¸­çš„åç§»é‡, ç”¨äºå¤§å‹ç›®å½•çš„åˆ†é¡µè¯»å–, åœ¨ç®€å•å®ç°ä¸­é€šå¸¸è¢«å¿½ç•¥ï¼ˆå¦‚ä»£ç ä¸­çš„(void)offsetï¼‰
 * @param fi åŒ…å«æ‰“å¼€ç›®å½•çš„ä¿¡æ¯, å¯ç”¨äºåœ¨å¤šæ¬¡è°ƒç”¨é—´ä¿æŒçŠ¶æ€
 * @return
 */
static int hello_readdir(const char* path, void* buf, fuse_fill_dir_t filler, off_t offset, struct fuse_file_info* fi)
{
    (void)offset;
    (void)fi;

    if (strcmp(path, "/") != 0)
        return -ENOENT;

    filler(buf, ".", NULL, 0); // å½“å‰ç›®å½•
    filler(buf, "..", NULL, 0); // çˆ¶ç›®å½•
    filler(buf, hello_path + 1, NULL, 0); // hello.txtæ–‡ä»¶

    return 0;
}

/**
 * @brief
 * @param path è¯†åˆ«ç”¨æˆ·å½“å‰è¯·æ±‚æ“ä½œçš„æ˜¯å“ªä¸ªæ–‡ä»¶æˆ–ç›®å½•
 * @param fi
 * @return
 */
static int hello_open(const char* path, struct fuse_file_info* fi)
{
    if (strcmp(path, hello_path) != 0)
        return -ENOENT;

    if ((fi->flags & O_ACCMODE) != O_RDONLY)
        return -EACCES;

    return 0;
}

/**
 * @brief read the file
 * @param path è¯†åˆ«ç”¨æˆ·å½“å‰è¯·æ±‚æ“ä½œçš„æ˜¯å“ªä¸ªæ–‡ä»¶æˆ–ç›®å½•
 * @param buf
 * @param size
 * @param offset
 * @param fi
 * @return
 */
static int hello_read(const char* path, char* buf, size_t size, off_t offset, struct fuse_file_info* fi)
{
    (void)fi;

    if (strcmp(path, hello_path) != 0)
        return -ENOENT;

    const size_t len = strlen(hello_str);
    if (offset < len)
    {
        if (offset + size > len)
            size = len - offset;
        memcpy(buf, hello_str + offset, size);
    }
    else
    {
        size = 0;
    }

    return size;
}

/**
 * @brief
 */
static struct fuse_operations hello_oper = {
    .getattr = hello_getattr, //
    .readdir = hello_readdir,
    .open = hello_open,
    .read = hello_read,
};

int main(int argc, char* argv[])
{
    return fuse_main(argc, argv, &hello_oper, NULL);
}

```

### ç¼–è¯‘åä½¿ç”¨

```bash
yeisme@yeisme:~/code/fuse_lib_dev$ ./build/fuse_lib_dev --help
usage: ./build/fuse_lib_dev mountpoint [options]

general options:
    -o opt,[opt...]        mount options
    -h   --help            print help
    -V   --version         print version

FUSE options:
    -d   -o debug          enable debug output (implies -f)
    -f                     foreground operation
    -s                     disable multi-threaded operation

    -o allow_other         allow access to other users
    -o allow_root          allow access to root
    -o auto_unmount        auto unmount on process termination
    -o nonempty            allow mounts over non-empty file/dir
    -o default_permissions enable permission checking by kernel
    -o fsname=NAME         set filesystem name
    -o subtype=NAME        set filesystem type
    -o large_read          issue large read requests (2.4 only)
    -o max_read=N          set maximum size of read requests

    -o hard_remove         immediate removal (don't hide files)
    -o use_ino             let filesystem set inode numbers
    -o readdir_ino         try to fill in d_ino in readdir
    -o direct_io           use direct I/O
    -o kernel_cache        cache files in kernel
    -o [no]auto_cache      enable caching based on modification times (off)
    -o umask=M             set file permissions (octal)
    -o uid=N               set file owner
    -o gid=N               set file group
    -o entry_timeout=T     cache timeout for names (1.0s)
    -o negative_timeout=T  cache timeout for deleted names (0.0s)
    -o attr_timeout=T      cache timeout for attributes (1.0s)
    -o ac_attr_timeout=T   auto cache timeout for attributes (attr_timeout)
    -o noforget            never forget cached inodes
    -o remember=T          remember cached inodes for T seconds (0s)
    -o nopath              don't supply path if not necessary
    -o intr                allow requests to be interrupted
    -o intr_signal=NUM     signal to send on interrupt (10)
    -o modules=M1[:M2...]  names of modules to push onto filesystem stack

    -o max_write=N         set maximum size of write requests
    -o max_readahead=N     set maximum readahead
    -o max_background=N    set number of maximum background requests
    -o congestion_threshold=N  set kernel's congestion threshold
    -o async_read          perform reads asynchronously (default)
    -o sync_read           perform reads synchronously
    -o atomic_o_trunc      enable atomic open+truncate support
    -o big_writes          enable larger than 4kB writes
    -o no_remote_lock      disable remote file locking
    -o no_remote_flock     disable remote file locking (BSD)
    -o no_remote_posix_lock disable remove file locking (POSIX)
    -o [no_]splice_write   use splice to write to the fuse device
    -o [no_]splice_move    move data while splicing to the fuse device
    -o [no_]splice_read    use splice to read from the fuse device

Module options:

[iconv]
    -o from_code=CHARSET   original encoding of file names (default: UTF-8)
    -o to_code=CHARSET      new encoding of the file names (default: UTF-8)

[subdir]
    -o subdir=DIR           prepend this directory to all paths (mandatory)
    -o [no]rellinks         transform absolute symlinks to relative
```

{{< figure src="cli1.png" alt="cli" >}}
